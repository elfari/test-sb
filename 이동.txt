CREATE OR REPLACE TRIGGER TRG_MRO_SIMILAR_CHECK
AFTER INSERT ON MRO_INFO
FOR EACH ROW
WHEN (NEW.STATUS = 'C') -- [조건 1] STATUS가 'C'인 경우에만 트리거 실행
DECLARE
    -- 변수 선언이 필요하다면 여기에 작성
BEGIN
    /* [조건 2] 중복 방지를 위해 기존 유사도 결과 삭제 */
    -- 혹시라도 이전에 생성된 데이터가 있거나, 재진입하는 경우를 대비해 먼저 삭제합니다.
    DELETE FROM MRO_INFO_SIMILAR 
     WHERE REQ_NO = :NEW.REQ_NO;

    /* 유사도 분석 후 INSERT 로직 수행 */
    INSERT INTO MRO_INFO_SIMILAR (
        REQ_NO,
        SIMILAR_MASTID,
        SIMILARITY_PCT,
        RANK
    )
    SELECT :NEW.REQ_NO,
           MAT_ID,
           SIM_SCORE,
           RNK
      FROM (
            SELECT MAT_ID,
                   SIM_SCORE,
                   ROW_NUMBER() OVER(ORDER BY SIM_SCORE DESC) AS RNK
              FROM (
                    SELECT MAT_ID,
                           -- 함수 호출
                           FN_SIMILARITY_PCT(MATERIAL_NAME, :NEW.MATERIAL_NAME) AS SIM_SCORE
                      FROM MASTOUT
                     WHERE 1=1
                       -- [필수] 성능 최적화를 위한 1차 필터링 조건 (꼭 사용하세요!)
                       -- AND CATEGORY_ID = :NEW.CATEGORY_ID 
                   )
             WHERE SIM_SCORE >= 90  -- 90점 이상만
           )
     WHERE RNK <= 10; -- 상위 10개만

EXCEPTION
    WHEN OTHERS THEN
        -- 에러 발생 시 로그만 출력하고 트랜잭션은 진행
        DBMS_OUTPUT.PUT_LINE('Trigger Error (REQ_NO: ' || :NEW.REQ_NO || '): ' || SQLERRM);
END;
/

