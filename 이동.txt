<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" trimDirectiveWhitespaces="true" %>
<%@ page import="java.util.Arrays" %>
<%
    // --- [ë°±ì—”ë“œ ë¡œì§] ë°ì´í„° ì²˜ë¦¬ ì˜ì—­ (JDK 1.7 í˜¸í™˜) ---
    request.setCharacterEncoding("UTF-8");
    String action = request.getParameter("action");
    
    final int MAX_LINES = 10000;
    final double DELETE_PERCENTAGE = 0.3;

    if ("save".equals(action)) {
        String user = request.getParameter("user");
        String text = request.getParameter("text");
        
        if (user != null && text != null) {
            String existingText = (String) application.getAttribute("clipboard_" + user);
            if (existingText != null) {
                existingText = existingText.replaceFirst("^\\s*", "").replaceFirst("\\s*$", ""); // trim ëŒ€ì²´
            }
            
            text = text.replaceFirst("^\\s*", "").replaceFirst("\\s*$", ""); // trim ëŒ€ì²´
            
            String newText;
            if (existingText == null || existingText.isEmpty()) {
                newText = text;
            } else {
                newText = existingText + "\n" + text; 
            }
            
            String[] lines = newText.split("\\r?\\n"); 
            
            if (lines.length > MAX_LINES) {
                int linesToDelete = (int) (lines.length * DELETE_PERCENTAGE);
                if (linesToDelete == 0) linesToDelete = 1; 

                String[] remainingLines = Arrays.copyOfRange(lines, linesToDelete, lines.length);
                
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < remainingLines.length; i++) {
                    if (i > 0) {
                        sb.append("\n");
                    }
                    sb.append(remainingLines[i]);
                }
                newText = sb.toString();
            }
            
            newText = newText.replaceFirst("^\\s*", "").replaceFirst("\\s*$", ""); // ìµœì¢… trim ëŒ€ì²´
            application.setAttribute("clipboard_" + user, newText);
        }
        return;
    } else if ("load".equals(action)) {
        String user = request.getParameter("user");
        String text = (String) application.getAttribute("clipboard_" + user);
        out.print(text == null ? "" : text);
        return;
    }
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple VDI Clipboard (IE7/8 Compatible)</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- [ìŠ¤íƒ€ì¼] IE7/8 í˜¸í™˜ì„ ìœ„í•´ flex ì œê±° ë° float/width ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì • --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif; }
        .container {
            display: block; /* flex ì œê±° */
            height: 95vh;
            padding: 10px;
            box-sizing: border-box;
        }
        #textArea {
            width: 98%; /* flex ëŒ€ì²´ */
            height: 70%; /* flex ëŒ€ì²´ */
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            resize: none;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 10px;
        }
        .info-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 8px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        .controls {
            display: block; 
            margin-top: 10px;
            overflow: hidden;
        }
        .controls > * {
            float: left;
            margin-right: 10px;
        }
        select, button {
            padding: 10px 20px;
            border: 2px solid #007bff;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        #btnSend {
            background-color: #007bff;
            color: white;
            float: right;
        }
        /* --- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (IE7/8 í˜¸í™˜ íˆ¬ëª…ë„ ì ìš©) --- */
        #toastMessage {
            visibility: hidden;
            min-width: 250px;
            background-color: #333; /* IE7/8ì—ì„œ filter:alphaì™€ í•¨ê»˜ ì“°ê¸° ìœ„í•´ ë‹¨ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
            filter: alpha(opacity=70); /* IE7/8 íˆ¬ëª…ë„ 70% */
            color: #fff;
            text-align: center;
            border-radius: 10px; 
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            margin-left: -125px; /* ì¤‘ì•™ ì •ë ¬ (transform ëŒ€ì²´) */
            font-size: 17px;
            opacity: 0;
            filter: alpha(opacity=0); 
        }
        
        #toastMessage.show {
            visibility: visible;
            opacity: 1;
            filter: alpha(opacity=100); 
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="info-message">
            âš ï¸ **ìµœëŒ€ 1ë§Œ ë¼ì¸**ê¹Œì§€ ì €ì¥ë˜ë©° (ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë‚´ìš© 30% ì‚­ì œ), ì„œë²„ ì¬ì‹œì‘ ì‹œ **ë°ì´í„°ëŠ” ì‚­ì œ**ë©ë‹ˆë‹¤.
        </div>

        <textarea id="textArea" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤."></textarea>
        
        <div class="controls">
            <select id="userSelect">
                <option value="A">User A</option>
                <option value="B">User B</option>
            </select>

            <button id="btnLoad" onclick="loadText()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="btnSend" onclick="sendText()">ì „ì†¡</button>
        </div>
    </div>
    
    <div id="toastMessage"></div>

    <script type="text/javascript">
        // --- [JavaScript] IE7/8 í˜¸í™˜ì„ ìœ„í•œ ë³€ê²½ ---
        var textArea = document.getElementById('textArea');
        var userSelect = document.getElementById('userSelect');
        var toastMessage = document.getElementById('toastMessage');
        var lastLoadedText = "";
        
        // IE7/8 í˜¸í™˜: XMLHttpRequest ê°ì²´ ìƒì„± í•¨ìˆ˜
        function createXhr() {
            if (window.XMLHttpRequest) {
                return new XMLHttpRequest();
            } else if (window.ActiveXObject) {
                try {
                    return new ActiveXObject("Msxml2.XMLHTTP");
                } catch (e) {
                    try {
                        return new ActiveXObject("Microsoft.XMLHTTP");
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
        function showToast(message) {
            toastMessage.innerHTML = message;
            toastMessage.className = "show";
            
            setTimeout(function() { 
                toastMessage.className = toastMessage.className.replace("show", ""); 
            }, 2500);
        }

        // ì „ì†¡ í•¨ìˆ˜ (fetch ëŒ€ì‹  AJAX ì‚¬ìš©)
        function sendText() {
            var text = textArea.value; 
            var user = userSelect.value;
            
            text = text.replace(/^\s+|\s+$/g, ''); // trim() ëŒ€ì²´
            
            if (text === "") return; 

            textArea.value = ""; 

            var xhr = createXhr();
            if (!xhr) {
                alert("AJAXë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                return;
            }
            
            var url = 'clipboard.jsp?action=save';
            var params = 'user=' + encodeURIComponent(user) + '&text=' + encodeURIComponent(text);
            
            xhr.open('POST', url, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    showToast("âœ… ì „ì†¡ ì™„ë£Œ");
                    loadText(true); 
                }
            };
            
            xhr.send(params);
        }

        // ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (fetch ëŒ€ì‹  AJAX ì‚¬ìš©)
        function loadText(forceUpdate) {
            var user = userSelect.value;

            var xhr = createXhr();
            if (!xhr) {
                alert("AJAXë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                return;
            }
            
            var url = 'clipboard.jsp?action=load&user=' + encodeURIComponent(user) + '&_=' + new Date().getTime();
            
            xhr.open('GET', url, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var text = xhr.responseText;
                    
                    var trimmedText = text.replace(/^\s+|\s+$/g, ''); // trim() ëŒ€ì²´

                    if (trimmedText !== lastLoadedText || forceUpdate) {
                        textArea.value = trimmedText;
                        
                        if (trimmedText !== lastLoadedText && !forceUpdate) {
                           showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (ìë™ ë™ê¸°í™”)");
                        } else if (forceUpdate) {
                           showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
                        }
                        
                        lastLoadedText = trimmedText;
                    }
                }
            };
            
            xhr.send(null);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (addEventListener ëŒ€ì‹  attachEvent ì‚¬ìš©)
        if (textArea.addEventListener) { // í‘œì¤€
            textArea.addEventListener('keydown', function(e) {
                if (e.keyCode === 13) {
                    e.preventDefault();
                    sendText();
                }
            }, false);
        } else if (textArea.attachEvent) { // IE7/8
            textArea.attachEvent('onkeydown', function(e) {
                if (window.event.keyCode === 13) {
                    window.event.returnValue = false; 
                    sendText();
                }
            });
        }
        
        if (userSelect.addEventListener) { // í‘œì¤€
             userSelect.addEventListener('change', function() {
                lastLoadedText = "";
                loadText(true);
            }, false);
        } else if (userSelect.attachEvent) { // IE7/8
            userSelect.attachEvent('onchange', function() {
                lastLoadedText = "";
                loadText(true);
            });
        }

        // ìë™ ë™ê¸°í™”
        setInterval(loadText, 1000);

        // ì´ˆê¸° ë¡œë“œ
        loadText(true);
    </script>
</body>
</html>
