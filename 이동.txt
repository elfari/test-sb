CREATE OR REPLACE FUNCTION FNSIMPCT (
    p_exist IN VARCHAR2,
    p_input IN VARCHAR2
) RETURN NUMBER
IS
    -- 변수 정의
    vexistclean   VARCHAR2(4000);
    vinputclean   VARCHAR2(4000);
    vexistsorted  VARCHAR2(4000);
    vinputsorted  VARCHAR2(4000);
    v_similarity    NUMBER := 0;
BEGIN
    -- NULL 처리
    IF pexist IS NULL OR pinput IS NULL THEN
        RETURN 0;
    END IF;

    -- 동일 문자열 처리 (대소문자 무시)
    IF UPPER(pexist) = UPPER(pinput) THEN
        RETURN 100;
    END IF;

    -- 영문, 한글, 중문, 숫자 외 모든 문자를 공백으로 치환
    vexistclean := REGEXPREPLACE(UPPER(pexist), '[^A-Z0-9가-힣一-龥]', ' ');
    vinputclean := REGEXPREPLACE(UPPER(pinput), '[^A-Z0-9가-힣一-龥]', ' ');

    -- 토큰화 후 중복 제거 및 정렬
    WITH exist_tokens AS (
        SELECT DISTINCT REGEXPSUBSTR(vexist_clean, '[^ ]+', 1, LEVEL) AS token
        FROM dual
        CONNECT BY REGEXPSUBSTR(vexist_clean, '[^ ]+', 1, LEVEL) IS NOT NULL
    )
    SELECT LISTAGG(token, ' ') WITHIN GROUP (ORDER BY token)
    INTO vexistsorted
    FROM exist_tokens;

    WITH input_tokens AS (
        SELECT DISTINCT REGEXPSUBSTR(vinput_clean, '[^ ]+', 1, LEVEL) AS token
        FROM dual
        CONNECT BY REGEXPSUBSTR(vinput_clean, '[^ ]+', 1, LEVEL) IS NOT NULL
    )
    SELECT LISTAGG(token, ' ') WITHIN GROUP (ORDER BY token)
    INTO vinputsorted
    FROM input_tokens;

    -- 정렬과 상관없이 동일한 토큰 집합인지 확인
    IF vexistsorted = vinputsorted THEN
        -- 최종 문자열이 동일하지만 원본 입력이 다르면 99 처리
        IF UPPER(pexist) <> UPPER(pinput) THEN
            v_similarity := 99;
        ELSE
            v_similarity := 100;
        END IF;
    ELSE
        -- 문자열 유사도 계산 (공통 문자 비율)
        DECLARE
            vexistlen   NUMBER := LENGTH(REPLACE(vexistsorted, ' ', ''));
            vinputlen   NUMBER := LENGTH(REPLACE(vinputsorted, ' ', ''));
            vcommonlen  NUMBER := 0;
        BEGIN
            -- 공통 문자 수 계산
            FOR i IN 1 .. LENGTH(REPLACE(vexistsorted, ' ', '')) LOOP
                IF INSTR(REPLACE(vinputsorted, ' ', ''), SUBSTR(REPLACE(vexistsorted, ' ', ''), i, 1)) > 0 THEN
                    vcommonlen := vcommonlen + 1;
                END IF;
            END LOOP;

            -- 공통 문자 비율 = (공통문자 * 2) / (문자수 합계)
            vsimilarity := ROUND((vcommonlen  2) / (vexistlen + vinput_len)  100);
        END;
    END IF;

    RETURN v_similarity;
END;
/


이 버전부터 다시 얘기하자