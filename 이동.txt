<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MRO ìœ ì‚¬ ìì¬ ì¤‘ë³µ í™•ì¸ (ExtJS Grouped Grid)</title>
    
    <!-- ExtJS 6.2.0 CDN (4.2ì™€ í˜¸í™˜ë˜ëŠ” Classic í…Œë§ˆ ì‚¬ìš©) -->
    <!-- ì°¸ê³ : ì‹¤ì œ 4.2 í™˜ê²½ì—ì„œëŠ” ë¡œì»¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤. -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/classic/theme-triton/resources/theme-triton-all.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/ext-all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/classic/theme-triton/theme-triton.js"></script>

    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .intro-box {
            background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .btn-approve {
            background-color: #2196F3 !important;
            border-color: #2196F3 !important;
        }
        .btn-approve .x-btn-inner {
            color: #fff !important;
            font-weight: bold !important;
        }
        /* ê·¸ë¦¬ë“œ ë‚´ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .x-grid-editor .x-form-text {
            text-align: left;
        }
    </style>

    <script>
        Ext.onReady(function () {
            
            // 1. ëª¨ë¸ ì •ì˜
            Ext.define('MroSimilarModel', {
                extend: 'Ext.data.Model',
                fields: [
                    { name: 'REQ_NO', type: 'string' },       // ìš”ì²­ë²ˆí˜¸ (ê·¸ë£¹í•‘ ê¸°ì¤€)
                    { name: 'REQ_MAT_NAME', type: 'string' }, // ìš”ì²­ìì¬ëª…
                    { name: 'SIM_MAT_ID', type: 'string' },   // ìœ ì‚¬ìì¬ì½”ë“œ
                    { name: 'SIM_MAT_NAME', type: 'string' }, // ìœ ì‚¬ìì¬ëª…
                    { name: 'SIMILARITY_PCT', type: 'int' },  // ìœ ì‚¬ë„
                    { name: 'REASON', type: 'string' }        // ì‚¬ìœ 
                ]
            });

            // 2. ìŠ¤í† ì–´ ì •ì˜ (ë°ì´í„° í¬í•¨)
            var similarStore = Ext.create('Ext.data.Store', {
                model: 'MroSimilarModel',
                groupField: 'REQ_NO', // â˜… í•µì‹¬: ìš”ì²­ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘
                data: [
                    // ê·¸ë£¹ 1: ìš”ì²­ë²ˆí˜¸ 2024001
                    { REQ_NO: 'REQ-2024001', REQ_MAT_NAME: 'Fitting AC10-R1/4', SIM_MAT_ID: 'MAT-1001', SIM_MAT_NAME: 'Fitting AC10-R1/8', SIMILARITY_PCT: 95, REASON: '' },
                    { REQ_NO: 'REQ-2024001', REQ_MAT_NAME: 'Fitting AC10-R1/4', SIM_MAT_ID: 'MAT-1002', SIM_MAT_NAME: 'Fitting AC10-TypeA', SIMILARITY_PCT: 88, REASON: '' },
                    
                    // ê·¸ë£¹ 2: ìš”ì²­ë²ˆí˜¸ 2024002
                    { REQ_NO: 'REQ-2024002', REQ_MAT_NAME: 'Samsung NoteBook 15', SIM_MAT_ID: 'MAT-5050', SIM_MAT_NAME: 'LG NoteBook 15', SIMILARITY_PCT: 60, REASON: '' },
                    
                    // ê·¸ë£¹ 3: ìš”ì²­ë²ˆí˜¸ 2024003 (ìœ ì‚¬ë„ 100% ì¼€ì´ìŠ¤)
                    { REQ_NO: 'REQ-2024003', REQ_MAT_NAME: 'Ball Pen (Black)', SIM_MAT_ID: 'MAT-9999', SIM_MAT_NAME: 'Ball Pen (Black)', SIMILARITY_PCT: 100, REASON: '' }
                ]
            });

            // ë©”ì¸ í™”ë©´ ë²„íŠ¼ ë Œë”ë§
            Ext.create('Ext.container.Viewport', {
                layout: {
                    type: 'vbox',
                    align: 'center',
                    pack: 'center'
                },
                items: [{
                    xtype: 'component',
                    html: '<div class="intro-box"><h2>MRO ì¼ê´„ ê²°ì¬ í™”ë©´ ì‹œë®¬ë ˆì´ì…˜</h2><p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ì¬ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.<br>ìœ ì‚¬ ìì¬ê°€ ë°œê²¬ë˜ë©´ íŒì—…ì´ ëœ¹ë‹ˆë‹¤.</p></div>'
                }, {
                    xtype: 'button',
                    text: 'ì¼ê´„ ê²°ì¬ (3ê±´ ì„ íƒë¨)',
                    scale: 'large',
                    width: 200,
                    height: 50,
                    cls: 'btn-approve',
                    handler: function() {
                        showSimilarCheckPopup(similarStore);
                    }
                }]
            });

            // 3. íŒì—… ìƒì„± í•¨ìˆ˜
            function showSimilarCheckPopup(store) {
                
                var win = Ext.create('Ext.window.Window', {
                    title: 'âš ï¸ ì¤‘ë³µ ì˜ì‹¬ ìì¬ í™•ì¸',
                    width: 950,
                    height: 550,
                    layout: 'fit',
                    modal: true,
                    animateTarget: this, // ë²„íŠ¼ì—ì„œ íŒì—…ì´ ë‚˜ì˜¤ëŠ” ì• ë‹ˆë©”ì´ì…˜
                    
                    items: [{
                        xtype: 'grid',
                        store: store,
                        columnLines: true,
                        
                        // â˜… í•µì‹¬: ì…€ ì—ë””íŒ… í”ŒëŸ¬ê·¸ì¸
                        plugins: [
                            Ext.create('Ext.grid.plugin.CellEditing', {
                                clicksToEdit: 1,
                                listeners: {
                                    // [UX] ì‚¬ìœ  ë™ê¸°í™” ë¡œì§
                                    edit: function(editor, context) {
                                        var rec = context.record;
                                        var newVal = context.value;
                                        var reqNo = rec.get('REQ_NO');
                                        
                                        // ê°™ì€ ê·¸ë£¹(ìš”ì²­ë²ˆí˜¸)ì˜ ëª¨ë“  í–‰ì— ì‚¬ìœ  ë³µì‚¬
                                        context.grid.getStore().each(function(item){
                                            if(item.get('REQ_NO') === reqNo){
                                                item.set('REASON', newVal);
                                            }
                                        });
                                    }
                                }
                            })
                        ],

                        // â˜… í•µì‹¬: ê·¸ë£¹í•‘ ì„¤ì •
                        features: [{
                            ftype: 'grouping',
                            // ê·¸ë£¹ í—¤ë” í…œí”Œë¦¿: ìš”ì²­ì •ë³´ë¥¼ í—¤ë”ì— í‘œì‹œ
                            groupHeaderTpl: [
                                '<div style="padding:5px;">',
                                '<span style="color:#333; font-weight:bold; font-size:14px;">[{name}]</span>',
                                ' <span style="color:#555;">ìš”ì²­ ìì¬ëª…:</span> <span style="color:#000; font-weight:bold; font-size:14px; text-decoration:underline;">{[values.rows[0].data.REQ_MAT_NAME]}</span>',
                                '<span style="float:right; color:red; margin-right:10px;">(ìœ ì‚¬: {rows.length}ê±´)</span>',
                                '</div>'
                            ].join(''),
                            hideGroupedHeader: true,
                            startCollapsed: false,
                            enableGroupingMenu: false
                        }],

                        columns: [
                            { 
                                header: 'ìœ ì‚¬ ìì¬ì½”ë“œ', 
                                dataIndex: 'SIM_MAT_ID', 
                                width: 130,
                                align: 'center',
                                renderer: function(v) { return '<b>' + v + '</b>'; }
                            },
                            { 
                                header: 'ê¸°ì¡´ ìì¬ëª… (ìœ ì‚¬í’ˆ)', 
                                dataIndex: 'SIM_MAT_NAME', 
                                flex: 1,
                                cellWrap: true
                            },
                            { 
                                header: 'ìœ ì‚¬ë„', 
                                dataIndex: 'SIMILARITY_PCT', 
                                width: 100, 
                                align: 'center',
                                renderer: function(v) {
                                    if (v >= 100) return '<span style="color:red; font-weight:bold;">' + v + '% (ì¤‘ë³µ)</span>';
                                    if (v >= 90) return '<span style="color:orange; font-weight:bold;">' + v + '% (ìœ ì‚¬)</span>';
                                    return v + '%';
                                }
                            },
                            {
                                header: 'ğŸ“ ì§„í–‰ ì‚¬ìœ  ì…ë ¥ (í´ë¦­)',
                                dataIndex: 'REASON',
                                flex: 1.5,
                                tdCls: 'x-grid-cell-reason', 
                                editor: {
                                    xtype: 'textfield',
                                    allowBlank: false,
                                    emptyText: 'ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê·œê²© ìƒì´)'
                                },
                                renderer: function(v, meta) {
                                    if(!v) {
                                        meta.style = "background-color: #fff0f0; border: 1px dashed #ffcccc;";
                                        return '<span style="color:#999; font-style:italic;">[í•„ìˆ˜] í´ë¦­í•˜ì—¬ ì‚¬ìœ  ì…ë ¥...</span>';
                                    }
                                    meta.style = "background-color: #f0fdf4;";
                                    return '<span style="color:#000;">' + v + '</span>';
                                }
                            }
                        ],
                        
                        viewConfig: {
                            stripeRows: true,
                            enableTextSelection: true
                        }
                    }],
                    
                    dockedItems: [{
                        xtype: 'toolbar',
                        dock: 'bottom',
                        ui: 'footer',
                        padding: '10 20 10 20',
                        items: [
                            {
                                xtype: 'component',
                                html: '<span style="color:#666;">â„¹ï¸ ë™ì¼ ìš”ì²­ ê±´(ê·¸ë£¹) ë‚´ì—ì„œëŠ” ì‚¬ìœ ê°€ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.</span>'
                            },
                            '->',
                            {
                                text: 'ë°˜ë ¤ (ì…ë ¥ ì·¨ì†Œ)',
                                width: 120,
                                handler: function() { win.close(); }
                            },
                            {
                                text: 'ì‚¬ìœ  ì €ì¥ ë° ìŠ¹ì¸',
                                width: 150,
                                scale: 'medium',
                                formBind: true,
                                cls: 'btn-approve',
                                handler: function() {
                                    var store = win.down('grid').getStore();
                                    var missingReasons = [];
                                    var checkedReqs = [];
                                    
                                    // ìœ íš¨ì„± ê²€ì‚¬
                                    store.each(function(rec) {
                                        var reqNo = rec.get('REQ_NO');
                                        if(Ext.Array.indexOf(checkedReqs, reqNo) === -1) {
                                            checkedReqs.push(reqNo);
                                            var reason = rec.get('REASON');
                                            if (!reason || reason.trim() === '') {
                                                missingReasons.push(reqNo);
                                            }
                                        }
                                    });

                                    if (missingReasons.length > 0) {
                                        Ext.Msg.alert('ì…ë ¥ í™•ì¸', '<span style="color:red;">ëª¨ë“  ìš”ì²­ ê±´ì— ëŒ€í•´ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</span><br><br>ë¯¸ì…ë ¥ ê±´ìˆ˜: ' + missingReasons.length + 'ê±´');
                                        return;
                                    }

                                    Ext.Msg.confirm('ìŠ¹ì¸ í™•ì¸', 'ì…ë ¥í•˜ì‹  ì‚¬ìœ ë¡œ ìŠ¹ì¸ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn){
                                        if(btn === 'yes'){
                                            Ext.Msg.alert('ì™„ë£Œ', 'ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', function(){
                                                win.close();
                                            });
                                        }
                                    });
                                }
                            }
                        ]
                    }]
                }).show();
            }
        });
    </script>
</head>
<body>
</body>
</html>

