Ext.onReady(function () {

    // 1. ëª¨ë¸ ì •ì˜ (í•„ìš”í•œ í•„ë“œ êµ¬ì„±)
    Ext.define('MroSimilarModel', {
        extend: 'Ext.data.Model',
        fields: [
            { name: 'REQ_NO', type: 'string' },       // ìš”ì²­ë²ˆí˜¸ (ê·¸ë£¹í•‘ ê¸°ì¤€)
            { name: 'REQ_MAT_NAME', type: 'string' }, // ìš”ì²­ìì¬ëª…
            { name: 'SIM_MAT_ID', type: 'string' },   // ìœ ì‚¬ìì¬ì½”ë“œ
            { name: 'SIM_MAT_NAME', type: 'string' }, // ìœ ì‚¬ìì¬ëª…
            { name: 'SIMILARITY_PCT', type: 'int' },  // ìœ ì‚¬ë„
            { name: 'REASON', type: 'string' }        // ì‚¬ìœ  (ì…ë ¥ ëŒ€ìƒ)
        ]
    });

    // 2. ìŠ¤í† ì–´ ì •ì˜ (groupField í•„ìˆ˜)
    var similarStore = Ext.create('Ext.data.Store', {
        model: 'MroSimilarModel',
        groupField: 'REQ_NO', // â˜… í•µì‹¬: ìš”ì²­ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘
        data: [
            // [TEST DATA] ìƒí™©: ìš”ì²­ìì¬ 'Fitting AC10'ì´ 2ê°œì˜ ìœ ì‚¬ìì¬ì™€ ë§¤ì¹­ë¨
            { REQ_NO: 'REQ-2024001', REQ_MAT_NAME: 'Fitting AC10-R1/4', SIM_MAT_ID: 'MAT-1001', SIM_MAT_NAME: 'Fitting AC10-R1/8', SIMILARITY_PCT: 95, REASON: '' },
            { REQ_NO: 'REQ-2024001', REQ_MAT_NAME: 'Fitting AC10-R1/4', SIM_MAT_ID: 'MAT-1002', SIM_MAT_NAME: 'Fitting AC10-TypeA', SIMILARITY_PCT: 88, REASON: '' },
            
            // [TEST DATA] ìƒí™©: ìš”ì²­ìì¬ 'NoteBook'ì´ 1ê°œì˜ ìœ ì‚¬ìì¬ì™€ ë§¤ì¹­ë¨
            { REQ_NO: 'REQ-2024002', REQ_MAT_NAME: 'Samsung NoteBook', SIM_MAT_ID: 'MAT-5050', SIM_MAT_NAME: 'LG NoteBook', SIMILARITY_PCT: 60, REASON: '' }
        ]
    });

    // 3. íŒì—… ìœˆë„ìš° ìƒì„±
    var win = Ext.create('Ext.window.Window', {
        title: 'âš ï¸ ì¤‘ë³µ ì˜ì‹¬ ìì¬ í™•ì¸',
        width: 900,
        height: 500,
        layout: 'fit',
        modal: true,
        items: [{
            xtype: 'grid',
            store: similarStore,
            columnLines: true,
            
            // â˜… í•µì‹¬: ì…€ ì—ë””íŒ… í”ŒëŸ¬ê·¸ì¸ (ì‚¬ìœ  ì…ë ¥ì„ ìœ„í•´)
            plugins: [
                Ext.create('Ext.grid.plugin.CellEditing', {
                    clicksToEdit: 1,
                    listeners: {
                        // [UX ê¿€íŒ] í•œ í–‰ì˜ ì‚¬ìœ ë¥¼ ìˆ˜ì •í•˜ë©´, ê°™ì€ ê·¸ë£¹(ìš”ì²­ë²ˆí˜¸)ì˜ ëª¨ë“  í–‰ì— ì‚¬ìœ ë¥¼ ë³µì‚¬í•´ì¤Œ
                        edit: function(editor, context) {
                            var rec = context.record;
                            var newVal = context.value;
                            var reqNo = rec.get('REQ_NO');
                            
                            // ìŠ¤í† ì–´ ë‚´ ê°™ì€ ìš”ì²­ë²ˆí˜¸ë¥¼ ê°€ì§„ ë°ì´í„°ë“¤ì˜ ì‚¬ìœ ë¥¼ ë™ê¸°í™”
                            context.grid.getStore().each(function(item){
                                if(item.get('REQ_NO') === reqNo){
                                    item.set('REASON', newVal);
                                }
                            });
                        }
                    }
                })
            ],

            // â˜… í•µì‹¬: ê·¸ë£¹í•‘ ê¸°ëŠ¥ ì„¤ì •
            features: [{
                ftype: 'grouping',
                groupHeaderTpl: [
                    '<span style="color:blue; font-weight:bold;">ìš”ì²­ë²ˆí˜¸: {name}</span>',
                    '&nbsp;&nbsp;|&nbsp;&nbsp;',
                    'ìš”ì²­ìì¬ëª…: {[values.rows[0].data.REQ_MAT_NAME]}',
                    '&nbsp;&nbsp;',
                    '<span style="color:red;">(ìœ ì‚¬ê±´ìˆ˜: {rows.length}ê±´)</span>'
                ].join(''),
                hideGroupedHeader: true, // ê·¸ë£¹í•‘ ê¸°ì¤€ ì»¬ëŸ¼(REQ_NO)ì€ ê·¸ë¦¬ë“œì—ì„œ ìˆ¨ê¹€
                startCollapsed: false    // ì²˜ìŒë¶€í„° í¼ì³ì„œ ë³´ì—¬ì¤Œ
            }],

            columns: [
                { 
                    header: 'ìœ ì‚¬ìì¬ì½”ë“œ', 
                    dataIndex: 'SIM_MAT_ID', 
                    width: 120,
                    align: 'center'
                },
                { 
                    header: 'ìœ ì‚¬ ìì¬ëª… (ê¸°ì¡´)', 
                    dataIndex: 'SIM_MAT_NAME', 
                    flex: 1,
                    renderer: function(v) {
                        return '<span style="color:#555;">' + v + '</span>';
                    }
                },
                { 
                    header: 'ìœ ì‚¬ë„', 
                    dataIndex: 'SIMILARITY_PCT', 
                    width: 80, 
                    align: 'center',
                    renderer: function(v) {
                        if (v >= 90) return '<b style="color:red;">' + v + '%</b>';
                        if (v >= 80) return '<b style="color:orange;">' + v + '%</b>';
                        return v + '%';
                    }
                },
                {
                    header: 'ğŸ“ ì§„í–‰ ì‚¬ìœ  ì…ë ¥ (í•„ìˆ˜)',
                    dataIndex: 'REASON',
                    flex: 1.5,
                    editor: {
                        xtype: 'textfield',
                        allowBlank: false,
                        emptyText: 'ì¤‘ë³µì´ ì•„ë‹˜ì„ ì†Œëª…í•˜ê±°ë‚˜ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'
                    },
                    renderer: function(v, meta) {
                        if(!v) {
                            meta.style = "background-color: #fff0f0;"; // ë¯¸ì…ë ¥ì‹œ ì—°í•œ ë¹¨ê°„ ë°°ê²½
                            return '<span style="color:gray; font-style:italic;">í´ë¦­í•˜ì—¬ ì‚¬ìœ  ì…ë ¥...</span>';
                        }
                        return v;
                    }
                }
            ]
        }],
        
        buttons: [
            {
                text: 'ë°˜ë ¤ (ì…ë ¥ ì·¨ì†Œ)',
                handler: function() {
                    win.close();
                }
            },
            {
                text: 'ì‚¬ìœ  ì €ì¥ ë° ìŠ¹ì¸',
                scale: 'medium',
                cls: 'btn-approve', // ë³„ë„ CSS í´ë˜ìŠ¤ ì ìš© ê°€ëŠ¥
                handler: function() {
                    var store = win.down('grid').getStore();
                    var invalidCount = 0;
                    
                    // ìœ íš¨ì„± ê²€ì‚¬: ëª¨ë“  ê·¸ë£¹ì— ì‚¬ìœ ê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    // (ê·¸ë£¹í•‘ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ distinctí•œ ìš”ì²­ë²ˆí˜¸ë³„ë¡œ ì²´í¬í•˜ëŠ” ë¡œì§ í•„ìš”)
                    var checkedReqs = [];
                    
                    store.each(function(rec) {
                        var reqNo = rec.get('REQ_NO');
                        if(Ext.Array.indexOf(checkedReqs, reqNo) === -1) {
                            checkedReqs.push(reqNo);
                            if (!rec.get('REASON') || rec.get('REASON').trim() === '') {
                                invalidCount++;
                            }
                        }
                    });

                    if (invalidCount > 0) {
                        Ext.Msg.alert('ì•Œë¦¼', 'ëª¨ë“  ìš”ì²­ ê±´ì— ëŒ€í•´ ì§„í–‰ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                        return;
                    }

                    Ext.Msg.confirm('í™•ì¸', 'ì…ë ¥í•˜ì‹  ì‚¬ìœ ë¡œ ìŠ¹ì¸ ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function(btn){
                        if(btn === 'yes'){
                            // TODO: ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ (AJAX)
                            console.log('ìŠ¹ì¸ ì²˜ë¦¬ ë¡œì§ ìˆ˜í–‰');
                            win.close();
                        }
                    });
                }
            }
        ]
    }).show();
});

