<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" trimDirectiveWhitespaces="true" %>
<%@ page import="java.util.Arrays" %>
<%
    // --- [ë°±ì—”ë“œ ë¡œì§] ë°ì´í„° ì²˜ë¦¬ ì˜ì—­ (JDK 1.7 í˜¸í™˜, ë³€ê²½ ì—†ìŒ) ---
    request.setCharacterEncoding("UTF-8");
    String action = request.getParameter("action");
    
    final int MAX_LINES = 10000;
    final double DELETE_PERCENTAGE = 0.3;

    if ("save".equals(action)) {
        String user = request.getParameter("user");
        String text = request.getParameter("text");
        
        if (user != null && text != null) {
            String existingText = (String) application.getAttribute("clipboard_" + user);
            if (existingText != null) {
                existingText = existingText.trim();
            }
            
            text = text.trim();
            
            String newText;
            if (existingText == null || existingText.isEmpty()) {
                newText = text;
            } else {
                newText = existingText + "\n" + text; 
            }
            
            String[] lines = newText.split("\\r?\\n"); 
            
            if (lines.length > MAX_LINES) {
                int linesToDelete = (int) (lines.length * DELETE_PERCENTAGE);
                if (linesToDelete == 0) linesToDelete = 1; 

                String[] remainingLines = Arrays.copyOfRange(lines, linesToDelete, lines.length);
                
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < remainingLines.length; i++) {
                    if (i > 0) {
                        sb.append("\n");
                    }
                    sb.append(remainingLines[i]);
                }
                newText = sb.toString();
            }
            
            newText = newText.trim();
            application.setAttribute("clipboard_" + user, newText);
        }
        return;
    } else if ("load".equals(action)) {
        String user = request.getParameter("user");
        String text = (String) application.getAttribute("clipboard_" + user);
        out.print(text == null ? "" : text);
        return;
    }
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple VDI Clipboard (IE8 Compatible)</title>
    <meta http-equiv="X-UA-Compatible" content="IE=8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- [ìŠ¤íƒ€ì¼] (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif; }
        .container {
            display: flex; /* IE8ì€ flex ì§€ì› ì•ˆí•¨. ë ˆì´ì•„ì›ƒì´ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë‚˜, ê¸°ë³¸ í¼ ìš”ì†ŒëŠ” ì˜ ë™ì‘í•©ë‹ˆë‹¤. */
            flex-direction: column;
            height: 95vh;
            padding: 10px;
            box-sizing: border-box;
        }
        /* IE8 í™˜ê²½ì—ì„œ ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ê°„ë‹¨í•œ width/height ì„¤ì • */
        #textArea {
            width: 98%; /* flex ëŒ€ì²´ */
            height: 70%; /* flex ëŒ€ì²´ */
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            resize: none;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 10px;
        }
        .info-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 8px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        .controls {
            /* IE8 í˜¸í™˜ì„ ìœ„í•´ float ë˜ëŠ” table layout í•„ìš”í•˜ë‚˜, ê¸°ë³¸ì ì¸ block/inline-blockìœ¼ë¡œ ì²˜ë¦¬ */
            /* flexëŠ” IE8ì—ì„œ ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì´ ë¶€ë¶„ì„ ì‚¬ìš©í•˜ëŠ” ê¸°ê¸°ëŠ” ë ˆì´ì•„ì›ƒì´ ë‹¤ë¥´ê²Œ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. */
            display: block; 
            margin-top: 10px;
            overflow: hidden; /* float í•´ì œ */
        }
        .controls > * {
            float: left;
            margin-right: 10px;
        }
        select, button {
            padding: 10px 20px;
            border: 2px solid #007bff;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        #btnSend {
            background-color: #007bff;
            color: white;
            float: right; /* ì „ì†¡ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ */
        }
        /* --- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ (IE8ì—ì„œë„ opacityì™€ position:fixed ì§€ì›) --- */
        #toastMessage {
            visibility: hidden;
            min-width: 250px;
            background-color: rgba(51, 51, 51, 0.7); 
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            margin-left: -125px; /* left: 50%ì™€ í•¨ê»˜ ì‚¬ìš© ì‹œ ì¤‘ì•™ ì •ë ¬ (transform ëŒ€ì²´) */
            font-size: 17px;
            opacity: 0;
            filter: alpha(opacity=0); /* IE8 opacity ì§€ì› */
            transition: opacity 0.5s, visibility 0s; /* IE8ì€ transitionì„ ì§€ì›í•˜ì§€ ì•Šì•„ ë¶€ë“œëŸ¬ì›€ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŒ */
        }
        
        #toastMessage.show {
            visibility: visible;
            opacity: 1;
            filter: alpha(opacity=100); /* IE8 opacity ì§€ì› */
            /* ì• ë‹ˆë©”ì´ì…˜ì€ IE8ì—ì„œ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë‹¨ìˆœ í‘œì‹œ/ìˆ¨ê¹€ë§Œ ì‘ë™í•¨ */
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="info-message">
            âš ï¸ **ìµœëŒ€ 1ë§Œ ë¼ì¸**ê¹Œì§€ ì €ì¥ë˜ë©° (ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë‚´ìš© 30% ì‚­ì œ), ì„œë²„ ì¬ì‹œì‘ ì‹œ **ë°ì´í„°ëŠ” ì‚­ì œ**ë©ë‹ˆë‹¤.
        </div>

        <textarea id="textArea" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤."></textarea>
        
        <div class="controls">
            <select id="userSelect">
                <option value="A">User A</option>
                <option value="B">User B</option>
            </select>

            <button id="btnLoad" onclick="loadText()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="btnSend" onclick="sendText()">ì „ì†¡</button>
        </div>
    </div>
    
    <div id="toastMessage"></div>

    <script type="text/javascript">
        // IE8 í˜¸í™˜ì„ ìœ„í•´ var ì‚¬ìš©
        var textArea = document.getElementById('textArea');
        var userSelect = document.getElementById('userSelect');
        var toastMessage = document.getElementById('toastMessage');
        var lastLoadedText = "";
        
        // IE8 í˜¸í™˜: XMLHttpRequest ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function createXhr() {
            if (window.XMLHttpRequest) {
                return new XMLHttpRequest(); // IE7+, Firefox, Chrome, Opera, Safari
            } else if (window.ActiveXObject) {
                // IE6, IE5
                try {
                    return new ActiveXObject("Msxml2.XMLHTTP");
                } catch (e) {
                    try {
                        return new ActiveXObject("Microsoft.XMLHTTP");
                    } catch (e) {
                        return null;
                    }
                }
            }
            return null;
        }

        // --- [í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜] ---
        function showToast(message) {
            toastMessage.innerHTML = message; // innerHTML ì‚¬ìš©
            toastMessage.className = "show";
            
            setTimeout(function() { 
                toastMessage.className = toastMessage.className.replace("show", ""); 
            }, 2500);
        }

        // [ê¸°ëŠ¥ 4 & í•„ìˆ˜ìš”ê±´] í…ìŠ¤íŠ¸ ì „ì†¡ (AJAX - IE8 í˜¸í™˜)
        function sendText() {
            var text = textArea.value; 
            var user = userSelect.value;
            
            // trim()ì€ IE8ì—ì„œ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì •ê·œì‹ì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ì²´ (ê°„ì†Œí™”ëœ ë²„ì „)
            text = text.replace(/^\s+|\s+$/g, ''); 
            
            if (text === "") return; 

            textArea.value = ""; 

            var xhr = createXhr();
            if (!xhr) {
                alert("AJAXë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                return;
            }
            
            var url = 'clipboard.jsp?action=save';
            var params = 'user=' + encodeURIComponent(user) + '&text=' + encodeURIComponent(text);
            
            xhr.open('POST', url, true);
            // Content-Type ì„¤ì • (IE8ì—ì„œ ì¤‘ìš”)
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                // í†µì‹  ì™„ë£Œ ë° ì„±ê³µ (HTTP 200)
                if (xhr.readyState === 4 && xhr.status === 200) {
                    showToast("âœ… ì „ì†¡ ì™„ë£Œ");
                    loadText(true); 
                }
            };
            
            xhr.send(params);
        }

        // [ê¸°ëŠ¥ 3] í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (AJAX - IE8 í˜¸í™˜)
        function loadText(forceUpdate) {
            var user = userSelect.value;

            var xhr = createXhr();
            if (!xhr) {
                alert("AJAXë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                return;
            }
            
            var url = 'clipboard.jsp?action=load&user=' + encodeURIComponent(user) + '&_=' + new Date().getTime(); // ìºì‹œ ë°©ì§€
            
            xhr.open('GET', url, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var text = xhr.responseText;
                    
                    // trim() ëŒ€ì‹  ì •ê·œì‹ ëŒ€ì²´
                    var trimmedText = text.replace(/^\s+|\s+$/g, ''); 

                    if (trimmedText !== lastLoadedText || forceUpdate) {
                        textArea.value = trimmedText;
                        
                        if (trimmedText !== lastLoadedText && !forceUpdate) {
                           showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (ìë™ ë™ê¸°í™”)");
                        } else if (forceUpdate) {
                           showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
                        }
                        
                        lastLoadedText = trimmedText;
                    }
                }
            };
            
            xhr.send(null);
        }

        // [í•„ìˆ˜ìš”ê±´ ëŒ€ì‘] ì—”í„° í‚¤ ì…ë ¥ ì‹œ ë°”ë¡œ ì „ì†¡ & ì¤„ë°”ê¿ˆ ë°©ì§€ (IE8 í˜¸í™˜)
        // IE8ì€ attachEvent ì‚¬ìš© (ì´ë²¤íŠ¸ ê°ì²´ ì ‘ê·¼ ë°©ì‹ ë‹¤ë¦„)
        if (textArea.addEventListener) { // í‘œì¤€ ë¸Œë¼ìš°ì €
            textArea.addEventListener('keydown', function(e) {
                if (e.keyCode === 13) { // keyCode 13 = Enter
                    e.preventDefault();
                    sendText();
                }
            }, false);
        } else if (textArea.attachEvent) { // IE8 ì´í•˜
            textArea.attachEvent('onkeydown', function(e) {
                if (window.event.keyCode === 13) {
                    window.event.returnValue = false; // ê¸°ë³¸ ë™ì‘(ì¤„ë°”ê¿ˆ) ë°©ì§€
                    sendText();
                }
            });
        }


        // [í•„ìˆ˜ìš”ê±´ ëŒ€ì‘] ìë™ ë™ê¸°í™” (1ì´ˆë§ˆë‹¤ ì„œë²„ ìƒíƒœ í™•ì¸)
        setInterval(loadText, 1000);

        // ì‚¬ìš©ì ë³€ê²½ ì‹œ ì¦‰ì‹œ í•´ë‹¹ ì‚¬ìš©ìì˜ ë°ì´í„° ë¡œë“œ (IE8 í˜¸í™˜)
        if (userSelect.addEventListener) {
             userSelect.addEventListener('change', function() {
                lastLoadedText = "";
                loadText(true);
            }, false);
        } else if (userSelect.attachEvent) {
            userSelect.attachEvent('onchange', function() {
                lastLoadedText = "";
                loadText(true);
            });
        }
        
        // ì´ˆê¸° ë¡œë“œ
        loadText(true);
    </script>
</body>
</html>
