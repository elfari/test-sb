<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ExtJS 4.2 Grouped Grid - 헤더 컨트롤 초기 로딩 완벽 보장</title>

    <link rel="stylesheet" type="text/css" 
          href="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/resources/css/ext-all.css">
    <script type="text/javascript" 
            src="https://cdnjs.cloudflare.com/ajax/libs/extjs/4.2.1/ext-all.js"></script>

    <script type="text/javascript">
        Ext.onReady(function() {

            var employeeStore = Ext.create('Ext.data.Store', {
                storeId: 'employeeStore',
                fields: ['name', 'seniority', 'department'],
                groupField: 'department',
                data: {
                    employees: [
                        { name: '김철수', seniority: 7, department: '경영' },
                        { name: '홍길동', seniority: 10, department: '경영' },
                        { name: '이영희', seniority: 2, department: '영업' },
                        { name: '박민수', seniority: 3, department: '영업' },
                        { name: '최지연', seniority: 4, department: '회계' },
                        { name: '정하나', seniority: 5, department: '회계' }
                    ]
                },
                proxy: {
                    type: 'memory',
                    reader: { type: 'json', root: 'employees' }
                }
            });

            var grid = Ext.create('Ext.grid.Panel', {
                title: '직원 목록 (부서별 그룹화 + 헤더 컨트롤)',
                store: employeeStore,
                columns: [
                    { text: '이름', dataIndex: 'name', flex: 1 },
                    { text: '근속년수', dataIndex: 'seniority', width: 100 },
                    { text: '부서', dataIndex: 'department', width: 120 }
                ],
                features: [{
                    ftype: 'grouping',
                    groupHeaderTpl: [
                        '<div class="group-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; width:100%;">',
                        '    <span class="group-title">{name} ({rows.length} 명)</span>',
                        '    <div class="group-controls" style="display:flex; gap:8px;">',
                        '        <div id="select-{name}"></div>',
                        '        <div id="input-{name}"></div>',
                        '    </div>',
                        '</div>'
                    ].join(''),
                    startCollapsed: false
                }],
                height: 500,
                width: 800,
                renderTo: Ext.getBody(),
                viewConfig: {
                    listeners: {
                        viewready: function(view) {
                            // viewready 후 강제로 한번 refresh 해서 그룹 헤더 확실히 그리기
                            Ext.defer(function() {
                                view.refresh();
                            }, 100);
                        },
                        refresh: function(view) {
                            // refresh 될 때마다 모든 그룹 컨트롤 생성 시도 (초기 로딩 보장)
                            createAllGroupControls();
                        },
                        groupcollapse: function(view, node, groupName) {
                            Ext.defer(function() {
                                createControlsForGroup(groupName);
                            }, 150);
                        },
                        groupexpand: function(view, node, groupName) {
                            Ext.defer(function() {
                                createControlsForGroup(groupName);
                            }, 150);
                        }
                    }
                }
            });

            // 모든 그룹에 대해 컨트롤 생성
            function createAllGroupControls() {
                var groups = employeeStore.getGroups();
                if (!groups || !groups.items) return;

                Ext.each(groups.items, function(group) {
                    createControlsForGroup(group.name);
                });
            }

            // 개별 그룹 컨트롤 생성 (중복 방지 + 안전한 ID 처리)
            function createControlsForGroup(groupName) {
                var encodedName = Ext.String.htmlEncode(groupName);  // 특수문자 방지
                var selectEl = Ext.get('select-' + encodedName);
                var inputEl = Ext.get('input-' + encodedName);

                if (selectEl && !selectEl.hasCls('control-created')) {
                    new Ext.form.field.ComboBox({
                        renderTo: selectEl,
                        width: 100,
                        store: ['전체', '승인', '거부'],
                        value: '전체',
                        editable: false,
                        listeners: {
                            change: function(combo, newValue) {
                                console.log('그룹 [' + groupName + '] 선택:', newValue);
                            }
                        }
                    });
                    selectEl.addCls('control-created');
                }

                if (inputEl && !inputEl.hasCls('control-created')) {
                    new Ext.form.field.Text({
                        renderTo: inputEl,
                        width: 120,
                        emptyText: '메모 입력...',
                        listeners: {
                            change: function(field, newValue) {
                                console.log('그룹 [' + groupName + '] 입력:', newValue);
                            }
                        }
                    });
                    inputEl.addCls('control-created');
                }
            }
        });
    </script>
</head>
<body>
</body>
</html>