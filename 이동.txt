<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.Arrays" %>
<%
    // --- [ë°±ì—”ë“œ ë¡œì§] ë°ì´í„° ì²˜ë¦¬ ì˜ì—­ (JDK 1.7 í˜¸í™˜) ---
    request.setCharacterEncoding("UTF-8");
    String action = request.getParameter("action");
    
    // ìµœëŒ€ ë¼ì¸ ìˆ˜ ë° ì‚­ì œ ë¹„ìœ¨ ìƒìˆ˜ ì •ì˜
    final int MAX_LINES = 10000;
    final double DELETE_PERCENTAGE = 0.3; // 30%

    // ë°ì´í„° ì €ì¥ì†Œ (ì„œë²„ ë©”ëª¨ë¦¬ ê³µìœ : application scope)
    if ("save".equals(action)) {
        String user = request.getParameter("user");
        String text = request.getParameter("text");
        
        if (user != null && text != null) {
            String existingText = (String) application.getAttribute("clipboard_" + user);
            
            // 1. ê¸°ì¡´ í…ìŠ¤íŠ¸ì— ìƒˆ í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€ (ì¤„ë°”ê¿ˆ ì¶”ê°€)
            String newText;
            if (existingText == null || existingText.isEmpty()) {
                newText = text;
            } else {
                newText = existingText + "\n" + text; 
            }
            
            // 2. ë¼ì¸ ìˆ˜ ê²€ì‚¬ ë° ì‚­ì œ ë¡œì§
            String[] lines = newText.split("\\r?\\n"); 
            
            if (lines.length > MAX_LINES) {
                int linesToDelete = (int) (lines.length * DELETE_PERCENTAGE);
                if (linesToDelete == 0) linesToDelete = 1; 

                // ìƒìœ„ linesToDelete ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë¼ì¸ë§Œ ì €ì¥
                String[] remainingLines = Arrays.copyOfRange(lines, linesToDelete, lines.length);
                
                // 3. JDK 1.7 í˜¸í™˜: StringBuilderë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°ì—´ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ í•©ì¹˜ê¸°
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < remainingLines.length; i++) {
                    if (i > 0) {
                        sb.append("\n");
                    }
                    sb.append(remainingLines[i]);
                }
                newText = sb.toString();
            }
            
            // 4. ì„œë²„ì— ìµœì¢… í…ìŠ¤íŠ¸ ì €ì¥
            application.setAttribute("clipboard_" + user, newText);
        }
        return; // HTML ë Œë”ë§ ì¤‘ë‹¨
    } else if ("load".equals(action)) {
        String user = request.getParameter("user");
        String text = (String) application.getAttribute("clipboard_" + user);
        out.print(text == null ? "" : text);
        return; // HTML ë Œë”ë§ ì¤‘ë‹¨
    }
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple VDI Clipboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- [ìŠ¤íƒ€ì¼] (ê¸°ì¡´ ìŠ¤íƒ€ì¼) --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Malgun Gothic', sans-serif; }
        .container {
            display: flex;
            flex-direction: column;
            height: 95vh;
            padding: 10px;
            box-sizing: border-box;
        }
        .info-message {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 8px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        #textArea {
            flex: 1;
            width: 100%;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            resize: none;
            box-sizing: border-box;
            outline: none;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
        }
        select {
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 16px;
            width: 80px;
            font-weight: bold;
            color: #007bff;
        }
        button {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background-color: #007bff;
            color: white;
        }
        #btnSend {
            background-color: #007bff;
            color: white;
            flex-grow: 1;
            max-width: 150px;
        }

        /* --- [ì¶”ê°€ëœ ìŠ¤íƒ€ì¼] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ --- */
        #toastMessage {
            visibility: hidden; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, visibility 0s;
        }
        
        #toastMessage.show {
            visibility: visible;
            opacity: 1;
            animation: fadein 0.5s, fadeout 0.5s 2s; /* 0.5ì´ˆ ë“±ì¥, 2ì´ˆ í›„ ì‚¬ë¼ì§ ì‹œì‘ */
        }

        /* ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes fadein {
            from {bottom: 0; opacity: 0;} 
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {opacity: 1;} 
            to {opacity: 0;}
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="info-message">
            âš ï¸ **ìµœëŒ€ 1ë§Œ ë¼ì¸**ê¹Œì§€ ì €ì¥ë˜ë©° (ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ë‚´ìš© 30% ì‚­ì œ), ì„œë²„ ì¬ì‹œì‘ ì‹œ **ë°ì´í„°ëŠ” ì‚­ì œ**ë©ë‹ˆë‹¤.
        </div>
        <textarea id="textArea" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì—”í„°(Enter)ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì „ì†¡ë©ë‹ˆë‹¤."></textarea>
        
        <div class="controls">
            <select id="userSelect">
                <option value="A">User A</option>
                <option value="B">User B</option>
            </select>

            <button id="btnLoad" onclick="loadText()">ë¶ˆëŸ¬ì˜¤ê¸°</button>

            <button id="btnSend" onclick="sendText()">ì „ì†¡</button>
        </div>
    </div>
    
    <div id="toastMessage"></div>

    <script>
        const textArea = document.getElementById('textArea');
        const userSelect = document.getElementById('userSelect');
        const toastMessage = document.getElementById('toastMessage');
        let lastLoadedText = "";

        // --- [ì¶”ê°€ëœ í•¨ìˆ˜] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ìˆ¨ê¹€ ---
        function showToast(message) {
            toastMessage.textContent = message;
            toastMessage.className = "show";
            
            // 2.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            setTimeout(function(){ 
                toastMessage.className = toastMessage.className.replace("show", ""); 
            }, 2500);
        }
        // ----------------------------------------------------

        // [ê¸°ëŠ¥ 4 & í•„ìˆ˜ìš”ê±´] í…ìŠ¤íŠ¸ ì „ì†¡ (AJAX)
        function sendText() {
            const text = textArea.value.trim(); 
            const user = userSelect.value;
            
            if (text === "") return; 

            textArea.value = ""; 

            fetch('clipboard.jsp?action=save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'user=' + encodeURIComponent(user) + '&text=' + encodeURIComponent(text)
            })
            .then(() => {
                showToast("âœ… ì „ì†¡ ì™„ë£Œ"); // ì „ì†¡ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                loadText(true); 
            });
        }

        // [ê¸°ëŠ¥ 3] í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (AJAX)
        function loadText(forceUpdate = false) {
            const user = userSelect.value;

            fetch('clipboard.jsp?action=load&user=' + encodeURIComponent(user))
            .then(response => response.text())
            .then(text => {
                const trimmedText = text.trim();

                if (trimmedText !== lastLoadedText || forceUpdate) {
                    textArea.value = trimmedText;
                    
                    // í…ìŠ¤íŠ¸ê°€ ì‹¤ì œë¡œ ë³€ê²½ë˜ê±°ë‚˜ ê°•ì œ ì—…ë°ì´íŠ¸ê°€ ì•„ë‹ˆë©´ ë©”ì‹œì§€ í‘œì‹œ ì•ˆí•¨
                    if (trimmedText !== lastLoadedText && !forceUpdate) {
                       showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (ìë™ ë™ê¸°í™”)");
                    } else if (forceUpdate) {
                       // ìˆ˜ë™ ë²„íŠ¼ í´ë¦­ì´ë‚˜ ì „ì†¡ ì§í›„ ê°•ì œ ë¡œë“œ ì‹œ ë©”ì‹œì§€ í‘œì‹œ
                       showToast("ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
                    }
                    
                    lastLoadedText = trimmedText;
                }
            });
        }

        // [í•„ìˆ˜ìš”ê±´ ëŒ€ì‘] ì—”í„° í‚¤ ì…ë ¥ ì‹œ ë°”ë¡œ ì „ì†¡ & ì¤„ë°”ê¿ˆ ë°©ì§€
        textArea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendText();
            }
        });

        // [í•„ìˆ˜ìš”ê±´ ëŒ€ì‘] ìë™ ë™ê¸°í™” (1ì´ˆë§ˆë‹¤ ì„œë²„ ìƒíƒœ í™•ì¸)
        setInterval(loadText, 1000);

        // ì‚¬ìš©ì ë³€ê²½ ì‹œ ì¦‰ì‹œ í•´ë‹¹ ì‚¬ìš©ìì˜ ë°ì´í„° ë¡œë“œ
        userSelect.addEventListener('change', () => {
            lastLoadedText = "";
            loadText(true);
        });

        // ì´ˆê¸° ë¡œë“œ
        loadText(true);
    </script>
</body>
</html>
