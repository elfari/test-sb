CREATE OR REPLACE PROCEDURE P_MRO_SIM_CHECK IS

    /* 변수 선언부: 루프 내에서 사용할 변수나 카운터 등이 있다면 선언 */
    v_process_cnt NUMBER := 0;

BEGIN
    /* 1. 대상 조회 루프 (STATUS='C' 이고 WORKING 컬럼이 비어있는 건) */
    FOR r IN (
        SELECT REQ_NO, 
               MATERIAL_NAME, 
               CATEGORY_ID -- 성능 최적화를 위해 카테고리 정보도 함께 조회 권장
          FROM MRO_INFO
         WHERE STATUS = 'C'
           AND WORKING IS NULL
    ) 
    LOOP
        BEGIN
            /* 2-1. 기존 분석 데이터 삭제 (재작업 시 중복 방지) */
            DELETE FROM MRO_INFO_SIMILAR 
             WHERE REQ_NO = r.REQ_NO;

            /* 2-2. 유사도 함수 호출 및 결과 저장 (INSERT) */
            INSERT INTO MRO_INFO_SIMILAR (
                REQ_NO,
                SIMILAR_MASTID,
                SIMILARITY_PCT,
                RANK,
                CREATED_DATE -- 생성일자 (테이블에 컬럼이 있다면)
            )
            SELECT r.REQ_NO,
                   MAT_ID,
                   SIM_SCORE,
                   RNK,
                   SYSDATE
              FROM (
                    SELECT MAT_ID,
                           SIM_SCORE,
                           ROW_NUMBER() OVER(ORDER BY SIM_SCORE DESC) AS RNK
                      FROM (
                            SELECT MAT_ID,
                                   /* 함수 호출: 기존 자재명 vs 요청 자재명 */
                                   FN_SIMILARITY_PCT(MATERIAL_NAME, r.MATERIAL_NAME) AS SIM_SCORE
                              FROM MASTOUT
                             WHERE 1=1
                               /* [성능 핵심] 전체 100만 건 비교는 느리므로 반드시 필터링 권장 
                                  예: 같은 카테고리 내에서만 비교 */
                               -- AND CATEGORY_ID = r.CATEGORY_ID 
                           )
                     WHERE SIM_SCORE >= 90  -- 유사도 90% 이상인 것만
                   )
             WHERE RNK <= 10; -- 상위 10건만 저장

            /* 3. 작업 완료 처리 (중요) */
            /* WORKING 컬럼을 'Y'(완료)로 업데이트하여 다음 실행 시 제외되도록 함 */
            UPDATE MRO_INFO
               SET WORKING = 'Y'
             WHERE REQ_NO = r.REQ_NO;
            
            /* 건별 커밋 (대량 데이터 처리 시 부하 분산) */
            COMMIT;
            
            v_process_cnt := v_process_cnt + 1;

        EXCEPTION
            WHEN OTHERS THEN
                /* 특정 건에서 에러가 나더라도 루프를 멈추지 않고 다음 건으로 진행 */
                ROLLBACK; -- 해당 건의 작업만 취소
                
                /* 에러 발생 표시 (WORKING 컬럼을 'E'(Error) 등으로 처리) */
                UPDATE MRO_INFO
                   SET WORKING = 'E' 
                 WHERE REQ_NO = r.REQ_NO;
                 
                COMMIT;
                DBMS_OUTPUT.PUT_LINE('Error on REQ_NO ' || r.REQ_NO || ': ' || SQLERRM);
        END;
        
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('Total Processed: ' || v_process_cnt);

END P_MRO_SIM_CHECK;
/

