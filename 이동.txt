CREATE OR REPLACE TRIGGER TRG_MRO_SIMILAR_CHECK
AFTER INSERT ON MRO_INFO
FOR EACH ROW
DECLARE
    /* 변수 선언이 필요하다면 여기에 작성 */
BEGIN
    /* MRO_INFO 에 신규 데이터(:NEW)가 들어오면 
       MASTOUT 전체(혹은 일부)와 비교하여 
       유사도가 90 이상인 것만 MRO_INFO_SIMILAR 에 적재 
    */
    
    INSERT INTO MRO_INFO_SIMILAR (
        REQ_NO,
        SIMILAR_MASTID,
        SIMILARITY_PCT,
        RANK
    )
    SELECT :NEW.REQ_NO,            -- 신규 요청 번호
           MAT_ID,                 -- 유사한 기존 자재 ID
           SIM_SCORE,              -- 유사도 점수
           RNK                     -- 순위
      FROM (
            SELECT MAT_ID,
                   SIM_SCORE,
                   /* 점수가 높은 순서대로 순위 매기기 */
                   ROW_NUMBER() OVER(ORDER BY SIM_SCORE DESC) AS RNK
              FROM (
                    SELECT MAT_ID,
                           /* 우리가 만든 유사도 함수 호출 */
                           FN_SIMILARITY_PCT(MATERIAL_NAME, :NEW.MATERIAL_NAME) AS SIM_SCORE
                      FROM MASTOUT
                     WHERE 1=1
                       /* [성능 최적화 필수 구간]
                          100만 건 전체 비교는 너무 느리므로, 같은 대분류/중분류 내에서만 비교하도록 
                          아래와 같은 조건을 반드시 추가하는 것이 좋습니다.
                       */
                       -- AND CATEGORY_ID = :NEW.CATEGORY_ID 
                   )
             WHERE SIM_SCORE >= 90  -- 90점 이상인 것만 필터링
           )
     WHERE RNK <= 10; -- (선택사항) 너무 많이 저장되지 않도록 상위 10개만 저장

EXCEPTION
    WHEN OTHERS THEN
        /* 유사도 체크 중 에러가 나더라도 
           본래의 자재 등록(INSERT)은 정상 처리되도록 예외를 무시하거나 로그만 남김 
        */
        DBMS_OUTPUT.PUT_LINE('유사도 체크 트리거 에러: ' || SQLERRM);
END;
/

